const i="http://127.0.0.1:8000";chrome.runtime.onInstalled.addListener(()=>{console.log("StonkGaze background ready - connected to backend at",i)});chrome.runtime.onMessage.addListener((e,t,o)=>{var a,s,c;if((e==null?void 0:e.type)!=="STONK_PAGE")return;const r={title:((a=e.payload)==null?void 0:a.title)||"",url:((s=e.payload)==null?void 0:s.url)||"",text:((c=e.payload)==null?void 0:c.text)||""};return chrome.storage.session.set({stonkSource:r}),chrome.runtime.sendMessage({type:"STONK_LOADING",payload:{title:r.title,url:r.url}}),d(r.text).then(n=>{chrome.runtime.sendMessage({type:"STONK_RESULT",payload:{...n,sourceTitle:r.title,sourceUrl:r.url}})}).catch(n=>{console.error("Backend API error:",n),chrome.runtime.sendMessage({type:"STONK_ERROR",payload:{error:n.message}})}),!0});async function d(e){if(!e||e.trim().length<50)throw new Error("Not enough content to analyze");const t=await fetch(`${i}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webpage_text:e})});if(!t.ok){const r=await t.json().catch(()=>({}));throw new Error(r.detail||`API error: ${t.status}`)}const o=await t.json();if(!o.success)throw new Error(o.error||"Analysis failed");return o}chrome.tabs.onUpdated.addListener((e,t)=>{t.status==="complete"&&chrome.tabs.sendMessage(e,{type:"STONK_REFRESH"})});chrome.runtime.onMessage.addListener(e=>{(e==null?void 0:e.type)==="STONK_MANUAL_REFRESH"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{var o;(o=t[0])!=null&&o.id&&chrome.tabs.sendMessage(t[0].id,{type:"STONK_REFRESH"})})});
