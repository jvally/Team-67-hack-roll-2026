const f="http://127.0.0.1:8000";let l=!1,c="",a=null,i=50;chrome.runtime.onInstalled.addListener(()=>{console.log("StonkGaze background ready - connected to backend at",f)});chrome.runtime.onMessage.addListener((e,t,o)=>{var n,u,d;if((e==null?void 0:e.type)==="STONK_MANUAL_REFRESH"){e.trollLevel!==void 0&&(i=e.trollLevel),l=!1,c="",chrome.tabs.query({active:!0,currentWindow:!0},y=>{var h;(h=y[0])!=null&&h.id&&chrome.tabs.sendMessage(y[0].id,{type:"STONK_REFRESH"})});return}if((e==null?void 0:e.type)!=="STONK_PAGE")return;const r={title:((n=e.payload)==null?void 0:n.title)||"",url:((u=e.payload)==null?void 0:u.url)||"",text:((d=e.payload)==null?void 0:d.text)||""};if(r.url===c&&l){console.log("Skipping duplicate analysis for:",r.url);return}return a&&clearTimeout(a),a=setTimeout(()=>{p(r)},300),!0});async function p(e){if(l){console.log("Analysis already in progress, skipping");return}l=!0,c=e.url;try{const t=await chrome.storage.local.get(["trollLevel"]);t.trollLevel!==void 0&&(i=t.trollLevel)}catch{console.log("Could not load troll level, using default:",i)}chrome.storage.session.set({stonkSource:e}),chrome.runtime.sendMessage({type:"STONK_LOADING",payload:{title:e.title,url:e.url}});try{const t=await S(e.text,i);chrome.runtime.sendMessage({type:"STONK_RESULT",payload:{...t,sourceTitle:e.title,sourceUrl:e.url}})}catch(t){console.error("Backend API error:",t),chrome.runtime.sendMessage({type:"STONK_ERROR",payload:{error:t.message}})}finally{l=!1}}async function S(e,t){if(!e||e.trim().length<50)throw new Error("Not enough content to analyze");const o=await fetch(`${f}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webpage_text:e,troll_level:t})});if(!o.ok){const n=await o.json().catch(()=>({}));throw new Error(n.detail||`API error: ${o.status}`)}const r=await o.json();if(!r.success)throw new Error(r.error||"Analysis failed");return r}let s=null;chrome.tabs.onUpdated.addListener((e,t,o)=>{t.status==="complete"&&(s&&clearTimeout(s),s=setTimeout(()=>{chrome.tabs.sendMessage(e,{type:"STONK_REFRESH"}).catch(()=>{})},500))});
