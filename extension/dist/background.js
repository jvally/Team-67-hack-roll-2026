const u="http://127.0.0.1:8000";let l=!1,c="",a=null,s=50;chrome.runtime.onInstalled.addListener(()=>{console.log("StonkGaze background ready - connected to backend at",u)});chrome.runtime.onMessage.addListener((e,t,o)=>{if(e?.type==="STONK_MANUAL_REFRESH"){e.trollLevel!==void 0&&(s=e.trollLevel),l=!1,c="",chrome.tabs.query({active:!0,currentWindow:!0},n=>{n[0]?.id&&chrome.tabs.sendMessage(n[0].id,{type:"STONK_REFRESH"})});return}if(e?.type!=="STONK_PAGE")return;const r={title:e.payload?.title||"",url:e.payload?.url||"",text:e.payload?.text||""};if(r.url===c&&l){console.log("Skipping duplicate analysis for:",r.url);return}return a&&clearTimeout(a),a=setTimeout(()=>{d(r)},300),!0});async function d(e){if(l){console.log("Analysis already in progress, skipping");return}l=!0,c=e.url;try{const t=await chrome.storage.local.get(["trollLevel"]);t.trollLevel!==void 0&&(s=t.trollLevel)}catch{console.log("Could not load troll level, using default:",s)}chrome.storage.session.set({stonkSource:e}),chrome.runtime.sendMessage({type:"STONK_LOADING",payload:{title:e.title,url:e.url}});try{const t=await y(e.text,s);chrome.runtime.sendMessage({type:"STONK_RESULT",payload:{...t,sourceTitle:e.title,sourceUrl:e.url}})}catch(t){console.error("Backend API error:",t),chrome.runtime.sendMessage({type:"STONK_ERROR",payload:{error:t.message}})}finally{l=!1}}async function y(e,t){if(!e||e.trim().length<50)throw new Error("Not enough content to analyze");const o=await fetch(`${u}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webpage_text:e,troll_level:t})});if(!o.ok){const n=await o.json().catch(()=>({}));throw new Error(n.detail||`API error: ${o.status}`)}const r=await o.json();if(!r.success)throw new Error(r.error||"Analysis failed");return r}let i=null;chrome.tabs.onUpdated.addListener((e,t,o)=>{t.status==="complete"&&(i&&clearTimeout(i),i=setTimeout(()=>{chrome.tabs.sendMessage(e,{type:"STONK_REFRESH"}).catch(()=>{})},500))});
